<!DOCTYPE html>
<html lang="en">
  <head>
    <title>Sous Vide by Kreaush</title>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link
      href="https://fonts.googleapis.com/css?family=Montserrat&display=swap"
      rel="stylesheet"
    />
    <!--===============================================================================================-->
    <link rel="icon" type="image/png" href="images/favicon.ico" />
    <!--===============================================================================================-->
    <link rel="stylesheet" type="text/css" href="fw/bootstrap.min.css" />
    <!--===============================================================================================-->
    <link rel="stylesheet" type="text/css" href="css/util.css" />
    <link rel="stylesheet" type="text/css" href="css/main.css" />
    <!--===============================================================================================-->
    <script
      type="text/javascript"
      src="https://www.gstatic.com/charts/loader.js"
    ></script>
    <script type="text/javascript">
      google.charts.load("current", { packages: ["corechart"] });
      google.charts.setOnLoadCallback(drawChart);

      function drawChart() {
        function doChart(csvString) {
          // transform the CSV string into a 2-dimensional array
          var arrayData = $.csv.toArrays(csvString, {
            onParseValue: $.csv.hooks.castToScalar
          });

          arrayData.shift();
          var t = arrayData[0][0].split(":");
          var hOffset = Number(t[0]);
          for (i in arrayData) {
            var t = arrayData[i][0].split(":");
            arrayData[i][0] = [];
            arrayData[i][0].push(Number(t[0]) - hOffset);
            arrayData[i][0].push(Number(t[1]));
            arrayData[i][0].push(Number(t[2]));
            console.log(arrayData[i][0]);
          }

          // this new DataTable object holds all the data

          var data = new google.visualization.DataTable();
          data.addColumn("timeofday", "Time");
          data.addColumn("number", "Temperature");
          data.addColumn("number", "Power");
          data.addColumn("number", "Target");

          data.addRows(arrayData);

          // set chart options
          var options = {
            curveType: "line",
            chartArea: {
              left: "10%",
              top: 20,
              right: "10%",
              bottom: 30
            },
            series: {
              2: { targetAxisIndex: 0 },
              0: { targetAxisIndex: 0 },
              1: { targetAxisIndex: 1 }
            },
            vAxes: {
              // Adds titles to each axis.
              0: { title: "Temps (Celsius)", minValue: 0, maxValue: 100 },
              1: {
                title: "Power Output",
                minValue: 0,
                maxValue: 1,
                format: "percent"
              }
            },
            vTicks: {
              1: {}
            },
            legend: { position: "bottom" }
          };

          // create the chart object and draw it
          var chart = new google.visualization.LineChart(
            document.getElementById("chart")
          );
          chart.draw(data, options);
        }
        // grab the CSV
        var jqxhr = $.get("/log.csv", function(csvString) {
          doChart(csvString);
        }).fail(function() {
          //transform the CSV string into a 2-dimensional array
          var csvString =
            "Time,Temperature,Output,Target\n0:00:00,0.00,10000.00,32\n0:10:59,10.00,10000.00,32\n0:20:21,0.00,10000.00,32\n9:20:05,100.00,10000.00,32";
          doChart(csvString);
        });
      }
    </script>
  </head>
  <body>
    <div class="limiter">
      <div class="container-all gradient-purple-blue">
        <div class="wrap-all">
          <div class="card fill settings">
            <div class="abar">
              <div class="kbar">
                <span class="bar left-bar">
                  <ul class="pager">
                    <li class="previous">
                      <a href="\"
                        ><span aria-hidden="true">&larr;</span> Back</a
                      >
                    </li>
                  </ul>
                </span>

                <span class="bar right-bar bar-title">
                  Settings
                </span>
              </div>
            </div>
            <div class="content">
              <div class="kbar title-bar">
                <span class="bar right-bar bar-button">
                  <ul class="pager">
                    <li>
                      <a class="small-btn btn-discard hidden"
                        ><span class="glyphicon glyphicon-remove"></span>
                      </a>
                    </li>
                    <li>
                      <a class="btn-autotune">Autotune</a>
                    </li>
                  </ul>
                </span>

                <span class="bar left-bar title">
                  Tunings
                </span>
              </div>

              <div class="wrap-input validate-input m-b-10">
                <input
                  class="input no-right kp s1 settings-input"
                  type="number"
                  step="1"
                  name="kp"
                  value="850"
                />
                <span class="focus-input"></span>
                <span class="symbol-start-input"> K<sub>p</sub> </span>
              </div>

              <div class="wrap-input validate-input m-b-10">
                <input
                  class="input no-right ki s001 settings-input"
                  type="number"
                  step="0.01"
                  name="kd"
                  value="0.5"
                />
                <span class="focus-input"></span>
                <span class="symbol-start-input"> K<sub>i</sub> </span>
              </div>
              <div class="wrap-input validate-input m-b-10">
                <input
                  class="input no-right kd s001 settings-input"
                  type="number"
                  step="0.01"
                  name="ki"
                  value="0.1"
                />
                <span class="focus-input"></span>
                <span class="symbol-start-input"> K<sub>d</sub> </span>
              </div>

              <div class="container-settings-btn">
                <button class="settings-btn hidden">
                  Save
                </button>
              </div>

              <div class="kbar title-bar">
                <span class="bar right-bar bar-button">
                  <ul class="pager">
                    <li>
                      <a onclick="drawChart()" class="small-btn"
                        ><span class="glyphicon glyphicon-refresh"></span>
                      </a>
                    </li>
                    <li>
                      <a href="log.csv">Download</a>
                    </li>
                  </ul>
                </span>

                <span class="bar left-bar title">
                  Log
                </span>
              </div>

              <div id="chart"></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!--===============================================================================================-->
    <script src="fw/jquery-3.2.1.min.js"></script>
    <script src="jquery.csv.js"></script>
    <!--===============================================================================================-->
    <script src="fw/bootstrap.min.js"></script>
    <!--===============================================================================================-->
    <script src="js/main.js"></script>
  </body>
</html>
